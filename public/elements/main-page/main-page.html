<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<!-- <link rel="import" href="../../bower_components/neon-animation/web-animations.html"> -->

<link rel="import" href="../../bower_components/shadycss/apply-shim.html">
<link rel="import" href="../shared-style/shared-style.html">

<link rel="import" href="../announcement-page/announcement-page.html">
<link rel="import" href="../profile-page/roomie-element.html">

<dom-module id="main-page">
  <template>
    <div id="main_container">
      <aside>
        <h2>Quick Filter</h2>
        <p>I am looking for:</p>
        <paper-button class="active" raised id="toggleRoomies" on-click="_setActive">Roomies</paper-button>
        <paper-button raised id="toggleAppartments" on-click="_setActive">Apartments</paper-button>

        <template is="dom-if" if="{{!toggle}}">
          <div>
            <p>Age</p>
            <paper-dropdown-menu id="age"  label="Choose age">
              <paper-listbox selected="0" slot="dropdown-content">
                <paper-item>All</paper-item>
                <paper-item>18-22</paper-item>
                <paper-item>22-26</paper-item>
                <paper-item>26-30</paper-item>
                <paper-item>30+</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </div>
        </template>

        <template is="dom-if" if="{{toggle}}">
          <div>
            <p>Maximum Price:</p>
            <paper-input id="price"></paper-input>
          </div>
          <div>
            <p>City:</p>
            <paper-dropdown-menu id="city"  label="Choose a city">
              <paper-listbox selected="0" slot="dropdown-content">
                <paper-item>All</paper-item>
                <paper-item>Bellinzona</paper-item>
                <paper-item>Locarno</paper-item>
                <paper-item>Lugano</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </div>
          </template>
          <div id="smoker-div">
            <p>Smokers:</p>
            <paper-checkbox on-change="_setCheckbox" id="smokers-y">Yes</paper-checkbox>
            <paper-checkbox on-change="_setCheckbox" id="smokers-n">No</paper-checkbox>
          </div>

          <div id="pets-div">
            <p>Pets:</p>
            <paper-checkbox on-change="_setCheckbox" id="pets-y">Yes</paper-checkbox>
            <paper-checkbox on-change="_setCheckbox" id="pets-n">No</paper-checkbox>
          </div>

          <div id="gender-div">
            <p>Gender:</p>
            <paper-checkbox on-change="_setCheckbox" id="gender-y">Male</paper-checkbox>
            <paper-checkbox on-change="_setCheckbox" id="gender-n">Female</paper-checkbox>
          </div>
        <template is="dom-if" if="{{toggle}}">
          <paper-button on-click="_filterAndDisplayLocation" raised>Filter!</paper-button>
        </template>

        <template is="dom-if" if="{{!toggle}}">
          <paper-button on-click="_filterAndDisplayRoomies" raised>Filter!</paper-button>
        </template>

      </aside>
      <main>
        <template is="dom-if" if="{{!toggle}}">
          <template is="dom-repeat" items="{{people}}" as="person">
            <paper-card preloadImage="true" fadeImage="true" heading="{{person.title}}" image="{{person.firstImage}}" alt="pic">
              <div>
                {{person.description}}
              </div>
              <div class="contact-buttons">
                <!-- <roomie-element></roomie-element> -->
                <announcement-page announcement="{{person}}"></announcement-page>
              </div>
            </paper-card>
          </template>
        </template>

        <!-- Apartments -->
        <template is="dom-if" if="{{toggle}}">
          <template is="dom-repeat" items="{{appartments}}" as="appartment">
            <paper-card preloadImage="true" fadeImage="true" heading="{{appartment.title}}" image="{{appartment.firstImage}}" alt="pic">
              <div>
                {{appartment.description}}
              </div>
              <div class="contact-buttons">
                <announcement-page announcement="{{appartment}}"></announcement-page>
              </div>
            </paper-card>
            <p>{{appartment.id}}</p>
          </template>
        </template>
      </main>
    </div>

    <style include="shared-style">
      .active {
        color: white;
        background-color: var(--shared-main-color);
      }

      #main_container {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: center;
        height: 100px;
      }

      aside {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        min-height: 100vh;
        height: 100%;
        text-align: center;
      }

      aside h2,
      p {
        text-align: center;
        font-family: var(--shared-text-font);
      }

      p {
        margin: 0;
        padding: 0;
      }

      paper-toggle-button {
      }

      main {
        display: flex;
        flex: 3;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-evenly;
      }

      paper-button {
        font-family: var(--shared-button-font);
        padding: 2px;
        text-align: center;
      }

      aside paper-button {
        display: block;
        margin: 5px;
        font-size: 1.5em;
      }

      .toggle {
        width: 40%;
      }

      paper-card {
        font-family: var(--shared-serious-font);
        max-width: 400px;
        height: auto;
        margin-bottom: 5px;
        --paper-card-header-color: white;
      }

      paper-card:hover {
        background-color: #f2f2f2;
        cursor: pointer;
      }

      .contact-buttons {
        display: flex;
        justify-content: center;
        font-size: 1.2em;
        margin-bottom: 3px;
      }

      paper-item {
        text-align: center;
      }
    </style>
  </template>
  <script src="../../ajax/ajax.js"></script>
  <script>
    class MainPage extends Polymer.Element {
      static get is() {
        return 'main-page';
      }

      static get properties() {
        return {
          appartments: {
            type: Array,
            value: () => []
          },
          people: {
            type: Array,
            value: () => []
          },
          toggle: {
            type: Boolean,
            value: false
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        // refreshLocation();
        // refreshRoomies();

        this._refreshRoomie();
        // this._refreshLocation();
      }

      _refreshLocation(){
        // console.log(document.querySelector("main-page"));
        doJSONRequest('GET', '/location', {}, {}, (par) => {
          this._popListLocation(par);
        })
      }

      _refreshRoomie(){
        doJSONRequest('GET', '/roomie', {}, {}, (par) => {
          this._popListRoomie(par);
        })
      }

      _deleteList(flag) {
        if (flag) {
          this.splice("appartments", 0, this.appartments.length);
        } else {
          this.splice("people", 0, this.people.length);
        }
      }

      _popListLocation(data) {
        this._deleteList(true);
          if (typeof data !== "undefined") {
            // let address;
            let addFun = this._addLocation.bind(this);
            data.forEach(function (e) {
              // address = e.city + ", " + e.street + " " + e.buildingNumber;
              addFun(e)
            });
          }
      }

    _popListRoomie(data) {
      this._deleteList(false);
      if (typeof data !== "undefined") {
        // let address;
        let addFun = this._addRoomie.bind(this);
        data.forEach(function (e) {
          // address = e.city + ", " + e.street + " " + e.buildingNumber;
          addFun(e)
        });
      }
    }

      _setActive(e) {
        console.log(this);
        console.log(this.shadowRoot);
        let el = e.path[0];
        if (el.className === "active") {
          return;
        } else {
          if (el.id === "toggleRoomies") {
            this.shadowRoot.querySelector("#toggleAppartments").className = "";
            this.toggle = false;
            this._refreshRoomie();
          }
          if (el.id === "toggleAppartments") {
            this.shadowRoot.querySelector("#toggleRoomies").className = "";
            this.toggle = true;
            this._refreshLocation()
          }
        }
        el.className = "active";
      }

      _addLocation(data) {
        this.push("appartments", {
          Id : data._id,
          description : data.description,
          images : data.pictures,
          requirements : [
            {description: "Smokers", control:Boolean, val : data.accept_smokers},
            {description: "Preffered gender", control: String, val : data.gender},
            {description: "Pets", control: Boolean, val : data.accept_animals}
          ],
          smarttitles : [
            {img: "../../src/img/bed.svg", val: data.bedrooms , title: "BEDROOM"},
            {img: "../../src/img/blueprint.svg", val: data.size, title: "ROOM SIZE"},
            {img: "../../src/img/money.svg", val: data.monthly_price, title: "RENT", notify: true},
            {img: "../../src/img/toilet.svg", val: data.bathrooms, title: "BATHROOMS"}
          ],
          title : data.city + ", " + data.street + " " + data.buildingNumber,
          type : true,
          firstImage : data.pictures[0],
          email: data.email
          });
      }

      _addRoomie(data) {
        this.push("people", {
          Id : data._id,
          description : data.description,
          images : data.picture,
          requirements : [
            {description: "Is a smoker", control:Boolean, val : data.smoker},
            // {description: "Gender", control: String, val : data.gender},
            {description: "Has a pet", control: Boolean, val : data.accept_animals}
          ],
          smarttitles : [
            {img: "../../src/img/money.svg", val: data.max_price , title: "RENT BUDGET"},
            {img: "../../src/img/blueprint.svg", val: data.age, title: "AGE"},
            {img: "../../src/img/money.svg", val: data.profession, title: "PROFESSION"},
            {img: "../../src/img/toilet.svg", val: data.gender, title: "GENDER"}
          ],
          title : data.name + " " + data.surname,
          type: false,
          firstImage : data.picture[0],
          email: data.email
          });
      }

      _setCheckbox(e) {
        let el = e.target;
        let parent = el.parentElement;
        let nextSibling = el.nextSibling.nextSibling;

        if(nextSibling==null) {
          el.previousSibling.previousSibling.checked = false;
        }else {
          nextSibling.checked = false;
        }
      }

    _filterAndDisplayLocation(e) {
      let filter = {};
      let price = this.shadowRoot.querySelector("#price").value
      let popListFun = this._popListLocation.bind(this);
      let city = this.shadowRoot.querySelector("#city").value;
      let checkboxes = this.shadowRoot.querySelectorAll("paper-checkbox");

      if(city !== "All") {
        filter.city = city;
      }
      if(typeof price !== 'undefined') {
        filter.monthly_price = {$gt: 0, $lt: price };
      }

      for(let i=0; i<checkboxes.length; i++) {
        if(checkboxes[i].checked) {
          let splitArr = checkboxes[i].id.split("-");

          if(splitArr[0]==="smokers") {
            if(splitArr[1]==="y") {
              filter.accept_smokers  = true;
            }else if(splitArr[1]==="n") {
              filter.accept_smokers  = false;
            }
          }

          if(splitArr[0]==="pets") {
            if(splitArr[1]==="y") {
              filter.accept_animals  = true;
            }else if(splitArr[1]==="n") {
              filter.accept_animals = false;
            }
          }

          if(splitArr[0]==="gender") {
            if(splitArr[1]==="y") {
              filter.gender = "Male";
            }else if(splitArr[1]==="n") {
              filter.gender = "Female";
            }
          }
        }
      }
        doJSONRequest("POST", "/location/query", {}, filter, function(e) {
          popListFun(e);
        });
      }

      _filterAndDisplayRoomies(e) {
        let filter = {};
        let age = this.shadowRoot.querySelector("#age").value;
        let popListFun = this._popListRoomie.bind(this);
        let checkboxes = this.shadowRoot.querySelectorAll("paper-checkbox");

        if(age !== "All") {
          let ageSplit = age.split("-");
          if(ageSplit.length < 2) {
            let newsplit = ageSplit[0].split("+");
            filter.age = {$gt:newsplit[0] , $lt:0};
          }else {
            filter.age = {$gt:ageSplit[0]-1 , $lt:ageSplit[1]}
          }
        }

        for(let i=0; i<checkboxes.length; i++) {
          if(checkboxes[i].checked) {
            let splitArr = checkboxes[i].id.split("-");

            if(splitArr[0]==="smokers") {
              if(splitArr[1]==="y") {
                filter.smoker  = true;
              }else if(splitArr[1]==="n") {
                filter.smoker  = false;
              }
            }

            if(splitArr[0]==="pets") {
              if(splitArr[1]==="y") {
                filter.accept_animals  = true;
              }else if(splitArr[1]==="n") {
                filter.accept_animals = false;
              }
            }

            if(splitArr[0]==="gender") {
              if(splitArr[1]==="y") {
                filter.gender = "Male";
              }else if(splitArr[1]==="n") {
                filter.gender = "Female";
              }
            }
          }
        }
          doJSONRequest("POST", "/roomie/query", {}, filter, function(e) {
            popListFun(e);
          });
        }
  }

    customElements.define(MainPage.is, MainPage);
  </script>
</dom-module>
